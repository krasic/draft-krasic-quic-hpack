<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Header Compression for HTTP over QUIC</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  body>ul.toc, body>#rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 550px);
    width: 300px;
    z-index: 1;
  }
  #rfc\.toc {
    top: 55px;
    overflow: auto;
    overscroll-behavior: contain;
  }
  ul.toc, #rfc\.toc {
    overflow: auto;
    overscroll-behavior: contain;
  }
  body>ul.toc {
    top: 140px;
  }

  body {
    padding-right: 350px;
  }
}

body {
  font: 16px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 24px;
  margin: 75px auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 36px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p, #rfc\.abstract p {
  font-size: 18px;
  line-height: 27px%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}
hr.noprint {
  display: none;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Head-of-Line Blocking in HPACK">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Avoiding Head-of-Line Blocking in HTTP/QUIC">
<link href="#rfc.section.2" rel="Chapter" title="2 HTTP over QUIC mapping extensions">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 HEADERS and PUSH_PROMISE">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 HEADER_ACK">
<link href="#rfc.section.3" rel="Chapter" title="3 HPACK extensions">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Allowed Instructions">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Header Block Prefix">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Hybrid absolute-relative indexing">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Preventing Eviction Races">
<link href="#rfc.section.3.4.1" rel="Chapter" title="3.4.1 Blocked Evictions">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 Refreshing Entries with Duplication">
<link href="#rfc.section.4" rel="Chapter" title="4 Performance considerations">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Speculative table updates">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Fixed overhead.">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Co-ordinated Packetization">
<link href="#rfc.section.5" rel="Chapter" title="5 Security Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.8.3 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Krasic, C." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-krasic-quic-qcram-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2018-1-23" />
  <meta name="dct.abstract" content="The design of the core QUIC transport subsumes many HTTP/2 features, prominent among them stream multiplexing.  A key advantage of the QUIC transport is stream multiplexing free of head-of-line (HoL) blocking between streams. In HTTP/2, multiplexed streams can suffer HoL blocking due to TCP." />
  <meta name="description" content="The design of the core QUIC transport subsumes many HTTP/2 features, prominent among them stream multiplexing.  A key advantage of the QUIC transport is stream multiplexing free of head-of-line (HoL) blocking between streams. In HTTP/2, multiplexed streams can suffer HoL blocking due to TCP." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">QUIC</td>
<td class="right">C. Krasic</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Google</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">January 23, 2018</td>
</tr>
<tr>
<td class="left">Expires: July 27, 2018</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Header Compression for HTTP over QUIC<br />
  <span class="filename">draft-krasic-quic-qcram-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The design of the core QUIC transport subsumes many HTTP/2 features, prominent among them stream multiplexing.  A key advantage of the QUIC transport is stream multiplexing free of head-of-line (HoL) blocking between streams. In HTTP/2, multiplexed streams can suffer HoL blocking due to TCP.</p>
<p>If HTTP/2&#8217;s HPACK is used for header compression, HTTP/QUIC is still vulnerable to HoL blocking, because of HPACK&#8217;s assumption of in-order delivery.  This draft defines QCRAM, a variation of HPACK and mechanisms in the HTTP/QUIC mapping that allow the flexibility to avoid header-compression-induced HoL blocking.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at https://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on July 27, 2018.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2018 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (https://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Head-of-Line Blocking in HPACK</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Avoiding Head-of-Line Blocking in HTTP/QUIC</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">HTTP over QUIC mapping extensions</a>
</li>
<ul><li>2.1.   <a href="#rfc.section.2.1">HEADERS and PUSH_PROMISE</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">HEADER_ACK</a>
</li>
</ul><li>3.   <a href="#rfc.section.3">HPACK extensions</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Allowed Instructions</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Header Block Prefix</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Hybrid absolute-relative indexing</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Preventing Eviction Races</a>
</li>
<ul><li>3.4.1.   <a href="#rfc.section.3.4.1">Blocked Evictions</a>
</li>
</ul><li>3.5.   <a href="#rfc.section.3.5">Refreshing Entries with Duplication</a>
</li>
</ul><li>4.   <a href="#rfc.section.4">Performance considerations</a>
</li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Speculative table updates</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Fixed overhead.</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Co-ordinated Packetization</a>
</li>
</ul><li>5.   <a href="#rfc.section.5">Security Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">Acknowledgments</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<ul><li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">The QUIC transport protocol was designed from the outset to support HTTP semantics, and its design subsumes many of the features of HTTP/2.  QUIC&#8217;s stream multiplexing comes into some conflict with  header compression.  A key goal of the design of QUIC is to improve stream multiplexing relative to HTTP/2 by eliminating HoL (head of line) blocking, which can occur in HTTP/2.  HoL blocking can happen because all HTTP/2 streams are multiplexed onto a single TCP connection with its in-order semantics.  QUIC can maintain independence between streams because it implements core transport functionality in a fully stream-aware manner.  However, the HTTP/QUIC mapping is still subject to HoL blocking if HPACK is used directly.  HPACK exploits multiplexing for greater compression, shrinking the representation of headers that have appeared earlier on the same connection.  In the context of QUIC, this imposes a vulnerability to HoL blocking (see <a href="#hol-example" class="xref">Section 1.1</a>).</p>
<p id="rfc.section.1.p.2">QUIC is described in <a href="#QUIC-TRANSPORT" class="xref">[QUIC-TRANSPORT]</a>.  The HTTP/QUIC mapping is described in <a href="#QUIC-HTTP" class="xref">[QUIC-HTTP]</a>. For a full description of HTTP/2, see <a href="#RFC7540" class="xref">[RFC7540]</a>. The description of HPACK is <a href="#RFC7541" class="xref">[RFC7541]</a>, with important terminology in Section 1.3.</p>
<p id="rfc.section.1.p.3">QCRAM modifies HPACK to allow correctness in the presence of out-of-order delivery, with flexibility for implementations to balance between resilience against HoL blocking and optimal compression ratio.  The design goals are to closely approach the compression ratio of HPACK with substantially less head-of-line blocking under the same loss conditions.</p>
<p id="rfc.section.1.p.4">QCRAM is intended to be a relatively non-intrusive extension to HPACK; an implementation should be easily shared within stacks supporting both HTTP/2 over (TLS+)TCP and HTTP/QUIC.</p>
<h2 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#hol-example" id="hol-example">Head-of-Line Blocking in HPACK</a>
</h2>
<p id="rfc.section.1.1.p.1">HPACK enables several types of header representations, one of which also adds the header to a dynamic table of header values.  These values are then available for reuse in subsequent header blocks simply by referencing the entry number in the table.</p>
<p id="rfc.section.1.1.p.2">If the packet containing a header is lost, that stream cannot complete header processing until the packet is retransmitted.  This is unavoidable. However, other streams which rely on the state created by that packet <em>also</em> cannot make progress. This is the problem which QUIC solves in general, but which is reintroduced by HPACK when the loss includes a HEADERS frame.</p>
<h2 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#overview-hol-avoidance" id="overview-hol-avoidance">Avoiding Head-of-Line Blocking in HTTP/QUIC</a>
</h2>
<p id="rfc.section.1.2.p.1">In the example above, the second stream contained a reference to data which might not yet have been processed by the recipient.  Such references are called &#8220;vulnerable,&#8221; because the loss of a different packet can keep the reference from being usable.</p>
<p id="rfc.section.1.2.p.2">The encoder can choose on a per-header-block basis whether to favor higher compression ratio (by permitting vulnerable references) or HoL resilience (by avoiding them). This is signaled by the BLOCKING flag in HEADERS and PUSH_PROMISE frames (see <a href="#hq-frames" class="xref">Section 2</a>).</p>
<p id="rfc.section.1.2.p.3">If a header block contains no vulnerable header fields, BLOCKING MUST be 0.  This implies that the header fields are represented either as references to dynamic table entries which are known to have been received, or as Literal header fields (see <a href="#RFC7541" class="xref">[RFC7541]</a> Section 6.2).</p>
<p id="rfc.section.1.2.p.4">If a header block contains any header field which references dynamic table state which the peer might not have received yet, the BLOCKING flag MUST be set.  If the peer does not yet have the appropriate state, such blocks might not be processed on arrival.</p>
<p id="rfc.section.1.2.p.5">The header block contains a prefix (<a href="#absolute-index" class="xref">Section 3.2</a>). This prefix contains table offset information that establishes total ordering among all headers, regardless of reordering in the transport (see <a href="#overview-absolute" class="xref">Section 3.3</a>).  In blocking mode, the prefix additionally identifies the minimum state required to process any vulnerable references in the header block (see <samp>Depends</samp> in Section <a href="#overview-absolute" class="xref">Section 3.3</a>).  When the necessary state has arrived, the header block can be processed. Notice that while blocked, HB&#8217;s header field data remains in stream B&#8217;s flow control window.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#hq-frames" id="hq-frames">HTTP over QUIC mapping extensions</a>
</h1>
<h2 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#headers-and-pushpromise" id="headers-and-pushpromise">HEADERS and PUSH_PROMISE</a>
</h2>
<p id="rfc.section.2.1.p.1">HEADERS and PUSH_PROMISE frames define a new flag.</p>
<p></p>

<dl>
<dt>BLOCKING (0x01):</dt>
<dd style="margin-left: 8">Indicates the stream might need to wait for dependent headers before processing.  If 0, the frame can be processed immediately upon receipt.</dd>
</dl>
<p id="rfc.section.2.1.p.3">HEADERS frames can be sent on the Connection Control Stream as well as on request / push streams.</p>
<h2 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#headerack" id="headerack">HEADER_ACK</a>
</h2>
<p id="rfc.section.2.2.p.1">The HEADER_ACK frame (type=0x8) is sent from the decoder to the encoder on the Control Stream when the decoder has fully processed a header block.  It is used by the encoder to determine whether subsequent indexed representations that might reference that block are vulnerable to HoL blocking.</p>
<p id="rfc.section.2.2.p.2">The HEADER_ACK frame indicates the stream on which the header block was processed by encoding the Stream ID as a variable-length integer. The same Stream ID can be identified multiple times, as multiple header-containing blocks can be sent on a single stream in the case of intermediate responses, trailers, pushed requests, etc. as well as on the Control Streams.</p>
<p id="rfc.section.2.2.p.3">Since header frames on each stream are received and processed in order, this gives the encoder precise feedback on which header blocks within a stream have been fully processed.  This information can then be used to correctly track outstanding stream references to checkpoints.</p>
<pre>
  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
|        Stream ID [i]          |
+---+---------------------------+
</pre>
<p class="figure">HEADER_ACK frame</p>
<p id="rfc.section.2.2.p.4">The HEADER_ACK frame does not define any flags.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#hpack-extensions" id="hpack-extensions">HPACK extensions</a>
</h1>
<h2 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#allowed-instructions" id="allowed-instructions">Allowed Instructions</a>
</h2>
<p id="rfc.section.3.1.p.1">HEADERS frames on the Control Streams SHOULD contain only Literal with Incremental Indexing representations.  Frames on this stream modify the dynamic table state without generating output to any particular request.</p>
<p id="rfc.section.3.1.p.2">HEADERS and PUSH_PROMISE frames on request and push streams MUST NOT contain Literal with Incremental Indexing representations.  Frames on these streams reference the dynamic table in a particular state without modifying it, but emit the headers for an HTTP request or response.</p>
<h2 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#absolute-index" id="absolute-index">Header Block Prefix</a>
</h2>
<p id="rfc.section.3.2.p.1">In HEADERS and PUSH_PROMISE frames, HPACK Header data is prefixed by an integer: <samp>Base Index</samp>.  <samp>Base index</samp> is the cumulative number of entries added to the table prior to encoding the current block, it is encoded as a single 8-bit prefix integer:</p>
<div id="rfc.figure.1"></div>
<div id="fig-base-index"></div>
<pre>
    0 1 2 3 4 5 6 7
   +-+-+-+-+-+-+-+-+
   |Base Index (8+)|
   +---------------+
</pre>
<p class="figure">Figure 1: Absolute indexing (BLOCKING=0x0)</p>
<p><a href="#overview-absolute" class="xref">Section 3.3</a> describes the role of <samp>Base Index</samp>.</p>
<p id="rfc.section.3.2.p.3">When the BLOCKING flag is 0x1, a the prefix additionally contains a second HPACK integer (8-bit prefix) &#8216;Depends&#8217;:</p>
<div id="rfc.figure.2"></div>
<div id="fig-prefix-long"></div>
<pre>
    0 1 2 3 4 5 6 7
   +-+-+-+-+-+-+-+-+
   |Base Index (8+)|
   +---------------+
   |Depends    (8+)|
   +---------------+
</pre>
<p class="figure">Figure 2: Absolute indexing (BLOCKING=0x1)</p>
<p id="rfc.section.3.2.p.4">Depends is used to identify header dependencies, namely the largest table entry referred to by indexed representations within the following header block.  Its usage is described in <a href="#overview-hol-avoidance" class="xref">Section 1.2</a>.  The largest index referenced is <samp>Base Index - Depends</samp>.</p>
<h2 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#overview-absolute" id="overview-absolute">Hybrid absolute-relative indexing</a>
</h2>
<p id="rfc.section.3.3.p.1">HPACK indexed entries refer to an entry by its current position in the dynamic table.  As Figure 1 of <a href="#RFC7541" class="xref">[RFC7541]</a> illustrates, newer entries have smaller indices, and older entries are evicted first if the table is full.  Under this scheme, each insertion to the table causes the index of all existing entries to change (implicitly).  Implicit index updates are acceptable for HTTP/2 because TCP is totally ordered, but are problematic in the out-of-order context of QUIC.</p>
<p id="rfc.section.3.3.p.2">QCRAM uses a hybrid absolute-relative indexing approach.  The prefix defined in <a href="#absolute-index" class="xref">Section 3.2</a> is used by the decoder to interpret all subsequent HPACK instructions at absolute positions for indexed lookups and insertions.</p>
<p id="rfc.section.3.3.p.3">Since QCRAM handles blocking at the header block level, it is an error if the HPACK decoder encounters an indexed representation that refers to an entry missing from the table, and the connection MUST be closed with the <samp>HTTP_HPACK_DECOMPRESSION_FAILED</samp> error code.</p>
<h2 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#evictions" id="evictions">Preventing Eviction Races</a>
</h2>
<p id="rfc.section.3.4.p.1">Due to out-of-order arrival, QCRAM&#8217;s eviction algorithm requires changes (relative to HPACK) to avoid the possibility that an indexed representation is decoded after the referenced entry has already been evicted.  QCRAM employs a two-phase eviction algorithm, in which the encoder will not evict entries that have outstanding (unacknowledged) references.</p>
<h3 id="rfc.section.3.4.1">
<a href="#rfc.section.3.4.1">3.4.1.</a> <a href="#blocked-evictions" id="blocked-evictions">Blocked Evictions</a>
</h3>
<p id="rfc.section.3.4.1.p.1">The decoder MUST NOT permit an entry to be evicted while a reference to that entry remains unacknowledged.  If a new header to be inserted into the dynamic table would cause the eviction of such an entry, the encoder MUST NOT emit the insert instruction until the reference has been processed by the decoder and acknowledged.</p>
<p id="rfc.section.3.4.1.p.2">The encoder can emit a literal representation for the new header in order to avoid encoding delays, and MAY insert the header into the table later if desired.</p>
<p id="rfc.section.3.4.1.p.3">To ensure that the blocked eviction case is rare, references to the oldest entries in the dynamic table SHOULD be avoided.  When one of the oldest entries in the table is still actively used for references, the encoder SHOULD emit an Indexed-Duplicate representation instead (see <a href="#indexed-duplicate" class="xref">Section 3.5</a>).</p>
<h2 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> <a href="#indexed-duplicate" id="indexed-duplicate">Refreshing Entries with Duplication</a>
</h2>
<div id="rfc.figure.3"></div>
<div id="fig-index-with-duplication"></div>
<pre>
    0 1 2 3 4 5 6 7
   +-+-+-+-+-+-+-+-+
   |0|0|1|Index(5+)|
   +-+-+-+---------+
</pre>
<p class="figure">Figure 3: Indexed Header Field with Duplication</p>
<p><em>Indexed-Duplicates</em> insert a new entry into the dynamic table which duplicates an existing entry. <a href="#RFC7541" class="xref">[RFC7541]</a> allows duplicate HPACK table entries, that is entries that have the same name and value.</p>
<p id="rfc.section.3.5.p.2">This replaces the HPACK instruction for Dynamic Table Size Update (see Section 6.3 of <a href="#RFC7541" class="xref">[RFC7541]</a>, which is not supported by HTTP over QUIC.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#performance-considerations" id="performance-considerations">Performance considerations</a>
</h1>
<h2 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#speculative-updates" id="speculative-updates">Speculative table updates</a>
</h2>
<p id="rfc.section.4.1.p.1">Implementations can <em>speculatively</em> send header frames on the HTTP Control Streams which are not needed for any current HTTP request or response.  Such headers could be used strategically to improve performance.  For instance, the encoder might decide to <em>refresh</em> by sending Indexed-Duplicate representations for popular header fields (<a href="#absolute-index" class="xref">Section 3.2</a>), ensuring they have small indices and hence minimal size on the wire.</p>
<h2 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#fixed-overhead" id="fixed-overhead">Fixed overhead.</a>
</h2>
<p id="rfc.section.4.2.p.1">HPACK defines overhead as 32 bytes (<a href="#RFC7541" class="xref">[RFC7541]</a> Section 4.1).  QCRAM adds some per-entry state, to track acknowledgment status and eviction reference count.  A larger value than 32 might be more accurate for QCRAM.</p>
<h2 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#co-ordinated-packetization" id="co-ordinated-packetization">Co-ordinated Packetization</a>
</h2>
<p id="rfc.section.4.3.p.1">When a dynamic table entry is both defined and referenced by header blocks within the same packet, there is no risk of HoL blocking and using an indexed representation is strictly better than using a literal.  An implementation could attempt to exploit this exception by employing co-ordination between QCRAM compression and QUIC transport packetization.  However, if the packet is lost, the transport might choose a different packetization when retransmitting the missing data.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.5.p.1">TBD.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.6.p.1">This document registers a new frame type, HEADER_ACK, for HTTP/QUIC. This will need to be added to the IANA Considerations of <a href="#QUIC-HTTP" class="xref">[QUIC-HTTP]</a>.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#acknowledgments" id="acknowledgments">Acknowledgments</a>
</h1>
<p id="rfc.section.7.p.1">This draft draws heavily on the text of <a href="#RFC7541" class="xref">[RFC7541]</a>.  The indirect input of those authors is gratefully acknowledged, as well as ideas from:</p>
<p></p>

<ul>
<li>Mike Bishop</li>
<li>Patrick McManus</li>
<li>Biren Roy</li>
<li>Alan Frindell</li>
<li>Ian Swett</li>
<li>Ryan Hamilton</li>
</ul>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h2 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="QUIC-HTTP">[QUIC-HTTP]</b></td>
<td class="top">
<a>Bishop, M.</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-http-08">Hypertext Transfer Protocol (HTTP) over QUIC</a>", Internet-Draft draft-ietf-quic-http-08, December 2017.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7541">[RFC7541]</b></td>
<td class="top">
<a>Peon, R.</a> and <a>H. Ruellan</a>, "<a href="https://tools.ietf.org/html/rfc7541">HPACK: Header Compression for HTTP/2</a>", RFC 7541, DOI 10.17487/RFC7541, May 2015.</td>
</tr>
</tbody></table>
<h2 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="QUIC-TRANSPORT">[QUIC-TRANSPORT]</b></td>
<td class="top">
<a>Iyengar, J.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-transport-08">QUIC: A UDP-Based Multiplexed and Secure Transport</a>", Internet-Draft draft-ietf-quic-transport-08, December 2017.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7540">[RFC7540]</b></td>
<td class="top">
<a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Charles 'Buck' Krasic</span> 
	  <span class="n hidden">
		<span class="family-name">Krasic</span>
	  </span>
	</span>
	<span class="org vcardline">Google</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ckrasic@google.com">ckrasic@google.com</a></span>

  </address>
</div>

</body>
</html>
